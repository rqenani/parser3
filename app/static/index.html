<!DOCTYPE html>
<html lang="sq">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Analizator Profesional i Listëpagesave (API)</title>
  <style>
    :root { --primary-color:#0d6efd; --success-color:#198754; --danger-color:#dc3545; --light-gray:#f8f9fa; --border-color:#dee2e6; --text-color:#212529; }
    body { font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif; background:#f0f2f5; color:var(--text-color); margin:0; padding:20px; }
    .container { max-width: 1400px; margin:0 auto; background:#fff; padding:30px; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.1); }
    h1,h2,h3 { text-align:center; color:var(--primary-color); }
    .tab-container { border:1px solid var(--border-color); border-radius:8px; overflow:hidden; margin-bottom:40px; }
    .tab-buttons { display:flex; background:var(--light-gray); }
    .tab-button { flex-grow:1; padding:15px; font-size:18px; font-weight:bold; background:var(--light-gray); border:none; border-bottom:3px solid transparent; cursor:pointer; }
    .tab-button.active { color:var(--primary-color); border-bottom-color:var(--primary-color); background:#fff; }
    .tab-content { display:none; padding:20px; }
    .tab-content.active { display:block; }
    textarea { width:100%; height:150px; padding:10px; border:1px solid #ccc; border-radius:6px; font-size:14px; margin-bottom:15px; box-sizing:border-box; }
    .button-container { display:grid; grid-template-columns: repeat(auto-fit,minmax(180px,1fr)); gap:10px; margin-bottom:15px; }
    button { padding:12px; font-weight:bold; color:#fff; background:var(--primary-color); border:none; border-radius:6px; cursor:pointer; }
    .export-btn { background:var(--success-color); }
    .section-title { margin-top:25px; text-align:left; border-bottom:1px solid var(--border-color); padding-bottom:5px; color:var(--primary-color); }
    .table-wrapper { overflow-x:auto; }
    table { width:100%; border-collapse:collapse; margin-top:15px; }
    th,td { border:1px solid var(--border-color); padding:8px; text-align:right; white-space:nowrap; font-size:14px; }
    th, td:first-child, td:nth-child(2) { text-align:left; }
    th { background:var(--light-gray); font-weight:600; }
    tfoot { font-weight:bold; background:#e9ecef; }
    .carousel-section { background:var(--light-gray); padding:30px; margin-top:40px; border-radius:8px; }
    .carousel-container { position:relative; background:#fff; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.08); padding:20px; min-height:200px; display:flex; align-items:center; justify-content:center; }
    .carousel-slide { display:none; width:100%; }
    .carousel-slide.active { display:block; }
    .carousel-nav { position:absolute; top:50%; left:0; width:100%; display:flex; justify-content:space-between; transform:translateY(-50%); pointer-events:none; }
    .carousel-button { pointer-events:all; width:40px; height:40px; border-radius:50%; background:rgba(0,0,0,0.5); color:#fff; border:none; font-size:20px; }
    .carousel-controls { display:flex; justify-content:space-between; align-items:center; margin-top:10px; }
    .dot { display:inline-block; width:12px; height:12px; background:#ccc; border-radius:50%; margin:0 5px; cursor:pointer; }
    .dot.active { background:var(--primary-color); }
    #clear-carousel-btn { background:var(--danger-color); }
    .muted { color:#888; font-style:italic; }
  </style>
</head>
<body>
<div class="container">
  <h1>Analizator Profesional i Listëpagesave (API)</h1>

  <div class="tab-container">
    <div class="tab-buttons">
      <button class="tab-button active" onclick="openTab(event,'tab-pf')">Analizator Person Fizik</button>
      <button class="tab-button" onclick="openTab(event,'tab-shpk')">Analizator SHPK / SHA</button>
    </div>

    <div id="tab-pf" class="tab-content active">
      <h3>Përpunues për Biznes Individual</h3>
      <textarea id="inputTextPF" placeholder="Ngjisni tekstin e listëpagesës për Person Fizik këtu..."></textarea>
      <div class="button-container">
        <button onclick="parseText('PF')">1. Përpuno Tekstin (Server)</button>
      </div>
      <div id="zgjedhjaDivPF"></div>
      <div class="button-container" id="postAnalysisButtonsPF" style="display:none;">
        <button onclick="gjeneroAnalizen('PF')">2. Gjenero Analizën & Shto te Karuseli</button>
        <button class="export-btn" onclick="exportToCSV('bank','PF')">Eksporto për Bankë</button>
        <button class="export-btn" onclick="exportToCSV('full','PF')">Eksporto Analizën e Plotë</button>
      </div>
    </div>

    <div id="tab-shpk" class="tab-content">
      <h3>Përpunues për SHPK / SHA</h3>
      <textarea id="inputTextSHPK" placeholder="Ngjisni tekstin e listëpagesës për SHPK/SHA këtu..."></textarea>
      <div class="button-container">
        <button onclick="parseText('SHPK')">1. Përpuno Tekstin (Server)</button>
      </div>
      <div id="zgjedhjaDivSHPK" class="muted">Për SHPK nuk kërkohet zgjedhje pronari.</div>
      <div class="button-container" id="postAnalysisButtonsSHPK" style="display:none;">
        <button onclick="gjeneroAnalizen('SHPK')">2. Gjenero Analizën & Shto te Karuseli</button>
        <button class="export-btn" onclick="exportToCSV('bank','SHPK')">Eksporto për Bankë</button>
        <button class="export-btn" onclick="exportToCSV('full','SHPK')">Eksporto Analizën e Plotë</button>
      </div>
    </div>
  </div>

  <div class="carousel-section">
    <h2>Rezultatet e Analizave Tuaja</h2>
    <div class="carousel-container" id="carousel-container">
      <div id="carousel-wrapper"><p class="muted">Analizat do të shfaqen këtu pasi të përpunoni një listëpagesë...</p></div>
      <div class="carousel-nav" id="carousel-nav" style="display:none;">
        <button class="carousel-button" onclick="changeSlide(-1)">&#10094;</button>
        <button class="carousel-button" onclick="changeSlide(1)">&#10095;</button>
      </div>
    </div>
    <div class="carousel-controls" id="carousel-controls" style="display:none;">
      <button id="clear-carousel-btn" onclick="clearCarousel()">Pastro Analizat</button>
      <div id="carousel-dots"></div>
    </div>
  </div>
  <footer class="site-footer" style="margin-top:30px; padding:20px; background:#2c3e50; border-radius:8px; color:#ecf0f1;">
    <div style="display:grid; grid-template-columns: repeat(auto-fit,minmax(280px,1fr)); gap:20px;">
      <section>
        <h3 style="margin-top:0;color:#fff;border-bottom:2px solid #0d6efd;padding-bottom:6px;">Rreth Mjetit</h3>
        <p>Ky mjet kryen parsing & llogaritje në backend (FastAPI) dhe shfaq rezultatet në frontend.</p>
      </section>
      <section id="credits-block">
        <h3 style="margin-top:0;color:#fff;border-bottom:2px solid #0d6efd;padding-bottom:6px;">Kush e krijoi Kartën e Biznesit</h3>
        <div id="credits-content" style="color:#bdc3c7;">Duke u ngarkuar…</div>
      </section>
      <section id="links-block">
        <h3 style="margin-top:0;color:#fff;border-bottom:2px solid #0d6efd;padding-bottom:6px;">Adresa & Lidhje të Dobishme</h3>
        <ul id="links-content" style="margin:0; padding-left:20px; color:#bdc3c7;"></ul>
      </section>
    </div>
  </footer>
</div>

<script>
let currentSlide = 0, slides=[], dots=[];
let parsedPF = null, parsedSHPK = null;
let bankPF=[], fullPF=[], bankSHPK=[], fullSHPK=[];
let metaPF=null, metaSHPK=null;
let selectedPFIndex=0;

function openTab(evt,tabName){
  document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
  document.querySelectorAll('.tab-button').forEach(tb => tb.classList.remove('active'));
  document.getElementById(tabName).classList.add('active');
  evt.currentTarget.classList.add('active');
}

function addSlide(title, html){
  const wrap = document.getElementById('carousel-wrapper');
  const dotsWrap = document.getElementById('carousel-dots');
  if(slides.length===0){
    wrap.innerHTML='';
    document.getElementById('carousel-nav').style.display='flex';
    document.getElementById('carousel-controls').style.display='flex';
  }
  const el = document.createElement('div');
  el.className='carousel-slide';
  el.innerHTML = `<h2>${title}</h2>` + html;
  wrap.appendChild(el);
  const dot = document.createElement('span');
  dot.className='dot';
  const idx=slides.length;
  dot.onclick=()=>showSlide(idx);
  dotsWrap.appendChild(dot);
  slides.push(el); dots.push(dot);
  showSlide(idx);
}
function showSlide(n){
  if(slides.length===0) return;
  slides.forEach(s=>s.classList.remove('active'));
  dots.forEach(d=>d.classList.remove('active'));
  slides[n].classList.add('active'); dots[n].classList.add('active');
  currentSlide=n;
}
function changeSlide(n){
  if(slides.length===0) return;
  let ni = currentSlide + n;
  if(ni>=slides.length) ni=0;
  if(ni<0) ni=slides.length-1;
  showSlide(ni);
}
function clearCarousel(){
  document.getElementById('carousel-wrapper').innerHTML='<p class="muted">Analizat do të shfaqen këtu pasi të përpunoni një listëpagesë...</p>';
  document.getElementById('carousel-dots').innerHTML='';
  slides=[]; dots=[]; currentSlide=0;
  document.getElementById('carousel-nav').style.display='none';
  document.getElementById('carousel-controls').style.display='none';
}

async function parseText(type){
  const text = document.getElementById(`inputText${type}`).value;
  if(!text.trim()){ alert("Ngjisni tekstin e listëpagesës."); return; }
  const r = await fetch('/api/parse',{
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({type, text})
  });
  if(!r.ok){ alert("Gabim gjatë përpunimit."); return; }
  const data = await r.json();
  if(type==='PF'){
    parsedPF = data.people; metaPF = data.meta;
    if(parsedPF.length===0){ document.getElementById('zgjedhjaDivPF').innerHTML='<p style="color:red">Nuk u gjetën të dhëna.</p>'; return; }
    // render radio
    let html = '<h3 class="section-title">Zgjidhni kush është Personi Fizik (Pronari)</h3>';
    parsedPF.forEach((p,i)=>{
      const checked = i===0 ? 'checked' : '';
      html += `<label style="display:block;margin-bottom:6px;"><input type="radio" name="personFizik" value="${i}" ${checked} onchange="selectedPFIndex=${i}"> ${p.emri} (${p.id})</label>`;
    });
    document.getElementById('zgjedhjaDivPF').innerHTML = html;
    document.getElementById('postAnalysisButtonsPF').style.display='grid';
  } else {
    parsedSHPK = data.people; metaSHPK = data.meta;
    if(parsedSHPK.length===0){ document.getElementById('zgjedhjaDivSHPK').innerHTML='<p style="color:red">Nuk u gjetën të dhëna.</p>'; return; }
    document.getElementById('postAnalysisButtonsSHPK').style.display='grid';
  }
}

async function gjeneroAnalizen(type){
  let body = null;
  if(type==='PF'){
    const radios = document.querySelectorAll('input[name="personFizik"]');
    radios.forEach(r=>{ if(r.checked) selectedPFIndex=parseInt(r.value); });
    body = { type, meta: metaPF, people: parsedPF, selectedIndex: selectedPFIndex };
  } else {
    body = { type, meta: metaSHPK, people: parsedSHPK };
  }
  const r = await fetch('/api/analyze',{
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify(body)
  });
  if(!r.ok){ alert("Gabim në analizë."); return; }
  const out = await r.json();
  addSlide(out.slideTitle, (out.accountingHTML||'') + (out.personFizikHTML||'') + (out.tablePunonjesHTML||''));
  if(type==='PF'){ bankPF = out.bankData; fullPF = out.fullData; }
  else { bankSHPK = out.bankData; fullSHPK = out.fullData; }
}

function exportToCSV(what,type){
  const data = (type==='PF') ? (what==='bank'? bankPF:fullPF) : (what==='bank'? bankSHPK:fullSHPK);
  if(!data || data.length===0){ alert("Nuk ka të dhëna për eksport."); return; }
  const header = Object.keys(data[0]);
  let csv = header.join(";") + "\n";
  data.forEach(row=>{
    csv += header.map(k=> typeof row[k]==='number' ? row[k].toString().replace('.',',') : `"${row[k]}"`).join(";") + "\n";
  });
  const blob = new Blob(["\uFEFF"+csv], {type:"text/csv;charset=utf-8;"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = (type==='PF' ? `pf_${what}.csv` : `shpk_${what}.csv`);
  document.body.appendChild(a);
  a.click();
  a.remove();
}

// --- Konfigurimi i krediteve/adr. ---
async function loadCredits(){
  try{
    const r = await fetch('/static/config.json', {cache:'no-store'});
    if(!r.ok) throw new Error('config missing');
    const cfg = await r.json();
    const c = cfg.businessCard || {};
    const cc = document.getElementById('credits-content');
    cc.innerHTML = `
      <div><strong>${c.designerName||''}</strong>${c.company? ' – '+c.company : ''}</div>
      <div>${c.phone? '📞 '+c.phone : ''}</div>
      <div>${c.email? '✉️ <a href="mailto:${c.email}" style="color:#9ad;">${c.email}</a>' : ''}</div>
      <div>${c.website? '🌐 <a href="${c.website}" target="_blank" rel="noopener noreferrer" style="color:#9ad;">${c.website}</a>' : ''}</div>
      ${(c.addressLines||[]).map(l=>`<div>${l}</div>`).join('')}
    `;
    const links = Array.isArray(cfg.usefulLinks) ? cfg.usefulLinks : [];
    const ul = document.getElementById('links-content');
    ul.innerHTML = links.map(x=>`<li><a href="${x.url}" target="_blank" rel="noopener noreferrer" style="color:#9ad;">${x.label}</a></li>`).join('');
  }catch(e){
    const cc = document.getElementById('credits-content');
    if(cc) cc.textContent = 'Nuk u gjet konfigurimi (config.json).';
  }
}
loadCredits();

</script>
</body>
</html>