<!DOCTYPE html>
<html lang="sq">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Analizator Profesional i Listëpagesave</title>
  <style>
    /* Reset & bazë */
    *,*::before,*::after{box-sizing:border-box}
    body{margin:0;padding:20px;min-height:100dvh;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;line-height:1.6;color:#212529;background:#f0f2f5}
    :root{--primary:#0d6efd;--success:#198754;--danger:#dc3545;--light:#f8f9fa;--border:#dee2e6;--shadow:0 4px 12px rgba(0,0,0,.1)}
    .container{max-width:1400px;margin:0 auto;background:#fff;padding:30px;border-radius:12px;box-shadow:var(--shadow)}
    h1,h2,h3{color:var(--primary);text-align:center;margin:0 0 16px}
    h1{font-size:clamp(22px,2.4vw,32px)} h2{font-size:clamp(18px,2vw,26px)} h3{font-size:clamp(16px,1.6vw,22px)}
    /* Tabs */
    .tab-container{border:1px solid var(--border);border-radius:12px;overflow:hidden;margin-bottom:40px;background:#fff}
    .tab-buttons{display:flex;background:var(--light)}
    .tab-button{flex:1;padding:14px 16px;font-weight:700;font-size:16px;background:var(--light);border:none;border-bottom:3px solid transparent;cursor:pointer;transition:.2s}
    .tab-button:hover{background:#e2e6ea}
    .tab-button.active{color:var(--primary);border-bottom-color:var(--primary);background:#fff}
    .tab-content{display:none;padding:20px;animation:fadeIn .35s}
    .tab-content.active{display:block}
    /* Inputs & butona */
    textarea{width:100%;height:150px;padding:12px;font-size:14px;border:1px solid #ccc;border-radius:8px;outline:none;transition:.2s}
    textarea:focus{border-color:var(--primary);box-shadow:0 0 0 3px rgba(13,110,253,.15)}
    .button-container{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin:14px 0 10px}
    button{padding:12px 14px;font-size:15px;font-weight:700;color:#fff;background:var(--primary);border:none;border-radius:10px;cursor:pointer;transition:.05s ease transform,.2s filter;box-shadow:0 2px 8px rgba(13,110,253,.25)}
    button:hover{filter:brightness(1.05)} button:active{transform:translateY(1px)}
    .export-btn{background:var(--success)}
    /* Tabela */
    .section-title{margin-top:24px;margin-bottom:8px;text-align:left;border-bottom:1px solid var(--border);padding-bottom:6px;color:var(--primary)}
    .table-wrapper{overflow-x:auto}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{border:1px solid var(--border);padding:10px;white-space:nowrap;font-size:14px;text-align:right}
    th,td:first-child,td:nth-child(2){text-align:left}
    th{background:var(--light);font-weight:600}
    tfoot{font-weight:700;background:#e9ecef}
    /* Karusel */
    .carousel-section{background:var(--light);padding:26px;margin-top:36px;border-radius:12px}
    .carousel-container{position:relative;background:#fff;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.08);padding:20px;min-height:200px;display:flex;align-items:center;justify-content:center}
    #carousel-placeholder{color:#999;font-style:italic}
    .carousel-slide{display:none;width:100%;animation:fadeIn .35s}
    .carousel-slide.active{display:block}
    .carousel-nav{position:absolute;top:50%;left:0;width:100%;display:flex;justify-content:space-between;transform:translateY(-50%);pointer-events:none;padding:0 10px}
    .carousel-button{pointer-events:all;background:rgba(0,0,0,.55);color:#fff;border:none;border-radius:50%;width:40px;height:40px;font-size:20px;cursor:pointer;transition:.2s}
    .carousel-button:hover{background:rgba(0,0,0,.8)}
    .carousel-controls{display:flex;justify-content:space-between;align-items:center;margin-top:12px}
    .carousel-dots{text-align:center}
    .dot{display:inline-block;width:12px;height:12px;margin:0 5px;background:#ccc;border-radius:50%;cursor:pointer;transition:.1s ease transform,.2s background}
    .dot:hover{transform:scale(1.1)} .dot.active{background:var(--primary)}
    #clear-carousel-btn{background:var(--danger)}
    /* Footer */
    .site-footer{margin-top:36px;padding:30px;background:#2c3e50;color:#ecf0f1;border-radius:12px;display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:24px}
    .site-footer h3{color:#fff;text-align:left;border-bottom:2px solid var(--primary);padding-bottom:8px;margin:0 0 12px}
    .site-footer p,.site-footer li{font-size:15px;color:#bdc3c7;text-align:left}
    .contact-button{display:inline-block;margin-top:12px;padding:12px 20px;background:var(--primary);color:#fff;text-decoration:none;border-radius:10px;font-weight:700;box-shadow:0 2px 8px rgba(13,110,253,.25)}
    .contact-button:hover{filter:brightness(1.08);transform:translateY(1px)}
    @keyframes fadeIn{from{opacity:.4;transform:translateY(1px)}to{opacity:1;transform:translateY(0)}}
    @media(max-width:560px){.container{padding:18px}.button-container{grid-template-columns:1fr}textarea{height:180px}}
  </style>
</head>
<body>
<div class="container">
  <h1>Analizator Profesional i Listëpagesave</h1>

  <!-- Tabs -->
  <div class="tab-container">
    <div class="tab-buttons">
      <button class="tab-button active" onclick="openTab(event,'tab-pf')">Analizator Person Fizik</button>
      <button class="tab-button" onclick="openTab(event,'tab-shpk')">Analizator SHPK / SHA</button>
    </div>

    <!-- PF -->
    <div id="tab-pf" class="tab-content active">
      <h3>Përpunues për Biznes Individual</h3>
      <textarea id="inputTextPF" placeholder="Ngjisni tekstin e listëpagesës për Person Fizik këtu..."></textarea>
      <div class="button-container">
        <button onclick="parseText('PF')">1. Përpuno Tekstin</button>
      </div>
      <div id="zgjedhjaDivPF"></div>
      <div class="button-container" id="postAnalysisButtonsPF" style="display:none;">
        <button onclick="gjeneroAnalizen('PF')">2. Gjenero Analizën & Shto te Karuseli</button>
        <button class="export-btn" onclick="exportToCSV('bank','PF')">Eksporto për Bankë</button>
        <button class="export-btn" onclick="exportToCSV('full','PF')">Eksporto Analizën e Plotë</button>
      </div>
    </div>

    <!-- SHPK -->
    <div id="tab-shpk" class="tab-content">
      <h3>Përpunues për SHPK / SHA</h3>
      <textarea id="inputTextSHPK" placeholder="Ngjisni tekstin e listëpagesës për SHPK/SHA këtu..."></textarea>
      <div class="button-container">
        <button onclick="parseText('SHPK')">1. Përpuno Tekstin</button>
      </div>
      <div id="zgjedhjaDivSHPK">Për SHPK nuk kërkohet zgjedhje pronari.</div>
      <div class="button-container" id="postAnalysisButtonsSHPK" style="display:none;">
        <button onclick="gjeneroAnalizen('SHPK')">2. Gjenero Analizën & Shto te Karuseli</button>
        <button class="export-btn" onclick="exportToCSV('bank','SHPK')">Eksporto për Bankë</button>
        <button class="export-btn" onclick="exportToCSV('full','SHPK')">Eksporto Analizën e Plotë</button>
      </div>
    </div>
  </div>

  <!-- Karusel -->
  <div class="carousel-section">
    <h2>Rezultatet e Analizave Tuaja</h2>
    <div class="carousel-container" id="carousel-container">
      <div id="carousel-wrapper"><p id="carousel-placeholder">Analizat do të shfaqen këtu pasi të përpunoni një listëpagesë...</p></div>
      <div class="carousel-nav" id="carousel-nav" style="display:none;">
        <button class="carousel-button" onclick="changeSlide(-1)">&#10094;</button>
        <button class="carousel-button" onclick="changeSlide(1)">&#10095;</button>
      </div>
    </div>
    <div class="carousel-controls" id="carousel-controls" style="display:none;">
      <button id="clear-carousel-btn" onclick="clearCarousel()">Pastro Analizat</button>
      <div id="carousel-dots"></div>
    </div>
  </div>
</div>

<footer class="site-footer">
  <section>
    <h3>Rreth Mjetit</h3>
    <p>Ky mjet u krijua për të thjeshtuar dhe automatizuar procesin e analizës së listëpagesave shqiptare, duke kursyer kohë dhe duke minimizuar gabimet njerëzore.</p>
    <ul>
      <li><strong>Për çfarë shërben?</strong> Përpunon automatikisht të dhënat, gjeneron regjistrimet kontabël dhe nxjerr detajet e pagave neto.</li>
      <li><strong>Për kë është?</strong> Për kontabilistë, financierë, menaxherë biznesi dhe studentë të ekonomisë në Shqipëri.</li>
    </ul>
  </section>
  <section>
    <h3>Autor & Kontakt</h3>
    <p>Zhvilluar nga <strong>Rubin Qenani</strong> (Auditues Ligjor & Ekspert Kontabël).</p>
    <a class="contact-button" href="https://rubinqenanibussinescard.netlify.app/" target="_blank" rel="noopener noreferrer">Vizitoni Kartën Time të Biznesit</a>
  </section>
</footer>

<script>
/* ----------------- KONFIG ----------------- */
/* Nëse UI është te i njëjti domain me API (Railway), lëre bosh. */
const API_BASE = ""; // p.sh. "https://analizolistepagesen-production.up.railway.app"

/* -------------- GJENDJE / KARUSEL --------- */
let currentSlide = 0, slides = [], dots = [];
let parsedPF=null, parsedSHPK=null, metaPF=null, metaSHPK=null, selectedPFIndex=0;
let bankPF=[], fullPF=[], bankSHPK=[], fullSHPK=[];

function openTab(evt,tabName){
  document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
  document.querySelectorAll('.tab-button').forEach(tb => tb.classList.remove('active'));
  document.getElementById(tabName).classList.add('active');
  evt.currentTarget.classList.add('active');
}
function addSlide(title, html){
  const wrap=document.getElementById('carousel-wrapper');
  const dotsWrap=document.getElementById('carousel-dots');
  if(slides.length===0){
    wrap.innerHTML='';
    document.getElementById('carousel-nav').style.display='flex';
    document.getElementById('carousel-controls').style.display='flex';
  }
  const el=document.createElement('div');
  el.className='carousel-slide';
  el.innerHTML = `<h2>${title}</h2>` + html;
  wrap.appendChild(el);
  const dot=document.createElement('span');
  dot.className='dot';
  const idx=slides.length;
  dot.onclick=()=>showSlide(idx);
  dotsWrap.appendChild(dot);
  slides.push(el); dots.push(dot);
  showSlide(idx);
}
function showSlide(n){
  if(slides.length===0) return;
  slides.forEach(s=>s.classList.remove('active'));
  dots.forEach(d=>d.classList.remove('active'));
  slides[n].classList.add('active'); dots[n].classList.add('active');
  currentSlide=n;
}
function changeSlide(n){
  if(slides.length===0) return;
  let ni=currentSlide+n;
  if(ni>=slides.length) ni=0;
  if(ni<0) ni=slides.length-1;
  showSlide(ni);
}
function clearCarousel(){
  document.getElementById('carousel-wrapper').innerHTML='<p id="carousel-placeholder">Analizat do të shfaqen këtu pasi të përpunoni një listëpagesë...</p>';
  document.getElementById('carousel-dots').innerHTML='';
  slides=[]; dots=[]; currentSlide=0;
  document.getElementById('carousel-nav').style.display='none';
  document.getElementById('carousel-controls').style.display='none';
}

/* ---------------- API CALLS ---------------- */
async function parseText(type){
  const text = document.getElementById(`inputText${type}`).value;
  if(!text.trim()){ alert("Ngjisni tekstin e listëpagesës."); return; }
  const r = await fetch(`${API_BASE}/api/parse`,{
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({type, text})
  });
  if(!r.ok){ alert("Gabim gjatë përpunimit."); return; }
  const data = await r.json();
  if(type==='PF'){
    parsedPF = data.people; metaPF = data.meta;
    if(!parsedPF || parsedPF.length===0){ document.getElementById('zgjedhjaDivPF').innerHTML='<p style="color:red">Nuk u gjetën të dhëna.</p>'; return; }
    // Zgjedhje pronari
    let html = '<h3 class="section-title">Zgjidhni kush është Personi Fizik (Pronari)</h3>';
    parsedPF.forEach((p,i)=>{
      const checked = i===0 ? 'checked' : '';
      html += `<label style="display:block;margin-bottom:6px;"><input type="radio" name="personFizik" value="${i}" ${checked} onchange="selectedPFIndex=${i}"> ${p.emri} (${p.id})</label>`;
    });
    document.getElementById('zgjedhjaDivPF').innerHTML = html;
    document.getElementById('postAnalysisButtonsPF').style.display='grid';
  } else {
    parsedSHPK = data.people; metaSHPK = data.meta;
    if(!parsedSHPK || parsedSHPK.length===0){ document.getElementById('zgjedhjaDivSHPK').innerHTML='<p style="color:red">Nuk u gjetën të dhëna.</p>'; return; }
    document.getElementById('postAnalysisButtonsSHPK').style.display='grid';
  }
}

async function gjeneroAnalizen(type){
  let body=null;
  if(type==='PF'){
    const radios=document.querySelectorAll('input[name="personFizik"]');
    radios.forEach(r=>{ if(r.checked) selectedPFIndex=parseInt(r.value); });
    body = { type, meta: metaPF, people: parsedPF, selectedIndex: selectedPFIndex };
  } else {
    body = { type, meta: metaSHPK, people: parsedSHPK };
  }
  const r = await fetch(`${API_BASE}/api/analyze`,{
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify(body)
  });
  if(!r.ok){ alert("Gabim në analizë."); return; }
  const out = await r.json();
  addSlide(out.slideTitle, (out.accountingHTML||'') + (out.personFizikHTML||'') + (out.tablePunonjesHTML||''));
  if(type==='PF'){ bankPF = out.bankData; fullPF = out.fullData; }
  else { bankSHPK = out.bankData; fullSHPK = out.fullData; }
}

/* -------------- EKSPORT CSV ---------------- */
function exportToCSV(what,type){
  const data = (type==='PF') ? (what==='bank'? bankPF:fullPF) : (what==='bank'? bankSHPK:fullSHPK);
  if(!data || data.length===0){ alert("Nuk ka të dhëna për eksport."); return; }
  const header = Object.keys(data[0]);
  let csv = header.join(";") + "\n";
  data.forEach(row=>{
    csv += header.map(k=> typeof row[k]==='number' ? row[k].toString().replace('.',',') : `"${row[k]}"`).join(";") + "\n";
  });
  const blob = new Blob(["\uFEFF"+csv], {type:"text/csv;charset=utf-8;"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = (type==='PF' ? `pf_${what}.csv` : `shpk_${what}.csv`);
  document.body.appendChild(a); a.click(); a.remove();
}
</script>
</body>
</html>
